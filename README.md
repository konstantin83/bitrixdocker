# Docker-compose для Битрикс

## Структура проекта

В проекте используется Nginx, PHP-FPM, MySQL и Redis.

Окружение проекта определяется в Nginx в глобальной переменной `BITRIX_ENV`, которая может принимать значения
`prod`, `dev` или `local`. В данном проекте она всегда равна `local`.

На окружение опирается логика в файле `bitrix/.settings_extra.php`, дополняющая значения файла `bitrix/.settings.php`.

Приложение (Битрикс) будет находиться в папке `www` проекта.

Redis используется для кэширования и хранения сессий.

Директория хранения временных файлов (`BX_TEMPORARY_FILES_DIRECTORY`) указывает на `/dev/shm` в контейнере php.
Этому `tmpfs` разделу в `docker-compose.yml` выделено максимум 1 ГБ памяти.

В контейнере `db` Mysql также используется `tmpfs` раздел для временных файлов, что позволяет ускорить работу базы данных.

## Установка и запуск контейнера

1. Убедитесь, что у вас установлен Docker и Docker Compose. [Инструкция по установке](https://docs.docker.com/compose/install/). А также Makefile [Инструкция по установке Makefile](https://www.gnu.org/software/make/).

2. В папке проекта выполните команду:

   ```bash
   make init
   ```

   Эта команда установит в папку битрикса (www) установочный скрипт `bitrixsetup.php` и скрипт для тестирования
   `bitrix_server_test.php`, а также создаст файл `.env` из шаблона `.env.default`
3. При необходимости отредактируйте файл `.env`, указав нужные параметры подключения к базе данных и другие настройки. **На локальном окружении рекомендуется использоваться дефолтные значения.**
4. Запустите контейнеры с помощью команды:

   ```bash
   make up
   ```
5. Перейдите в браузере на [скрипт установки Битрикс](http://localhost/bitrixsetup.php) и следуйте инструкциям
   установщика для разворачивания проекта по ссылке на резервную копию.
6. В случае проблем, можно обратиться к скрипту тестирования по ссылке [bitrix_server_test.php](http://localhost/bitrix_server_test.php).

## Дополнительные команды

Для остановки контейнеров выполните команду:

```bash
make stop
```

Для перезагрузки контейнеров выполните команду:

```bash
make restart
```

Более подробный перечень команд доступен с помощью:

```bash
make help
```

## Установка на Windows немного отличается от Linux и Macos

Вместо команд с make выполните следующие:

1. Скопируйте файл `.env.default` в `.env` и создайте папку `www/uploads`

2. Скачайте файл по ссылке `https://www.1c-bitrix.ru/download/files/scripts/restore.php` и поместите его в папку `www/`

3. Запустите контейнеры с помощью команды:
   ```bash
   docker-compose up -d
   ```

4. Докер на windows имеет большие сложности с производительностью при работе с диском через mounted volume. Поэтому
распаковка архива с резервной копией может занять много времени. Поэтому рекомендуется вручную распаковать архив с
резервной копией в папку `www/` перед запуском установочного скрипта. Необходимо убедиться, что файлы и папки,
начинающиеся с точки, также распаковались и находятся внутри `www/`. После чего в скрипте восстановления указать,
что архив уже распакован. Что переведёт вас на процесс распаковки БД, который уже выполняется очень быстро.

5. Чтобы установить Битрикс, перейдите в браузере на [скрипт установки Битрикс](http://localhost/bitrixsetup.php) и
следуйте инструкциям установщика.

6. Чтобы перезагрузить контейнеры, выполните команду:
   ```bash
   docker-compose restart
   ```

7. Чтобы остановить контейнеры, выполните команду:
   ```bash
   docker-compose stop
   ```

## PHPStorm

В проекте используется git, а во вложенной папке `www` находится приложение Битрикс со своим git-ом.
Для корректной работы в `PHPStorm` необходимо настроить вложенность гитов.

Добавить в разделе PHPStorm `Settings -> Version Control -> Directory Mappings` путь к папке `www` как вложенный
репозиторий.
Это позволит корректно работать с git в папке `www` и видеть изменения в файлах приложения.
